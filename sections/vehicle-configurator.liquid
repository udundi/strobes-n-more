{% comment %}
  Updated Vehicle Configurator Section with Vehicle Selection
  File: sections/vehicle-configurator.liquid
{% endcomment %}

{{ 'vehicle-configurator.css' | asset_url | stylesheet_tag }}

{% assign collection = collections[section.settings.product_collection] %}

<div class="configurator-container" id="vehicleConfigurator">
  <!-- Vehicle Selector -->
  <div class="vehicle-selector-overlay" id="vehicleSelector">
    <div class="vehicle-selector-modal">
      <h2>Select Your Vehicle</h2>
      <p>Choose your vehicle model to see compatible equipment</p>
      <div class="vehicle-options">
        {% for block in section.blocks %}
          {% if block.type == 'vehicle' %}
            <div class="vehicle-option" 
                 data-vehicle="{{ block.settings.vehicle_handle }}"
                 data-vehicle-name="{{ block.settings.vehicle_name }}">
              {% if block.settings.vehicle_image %}
                <img src="{{ block.settings.vehicle_image | img_url: '300x200' }}" 
                     alt="{{ block.settings.vehicle_name }}">
              {% endif %}
              <h3>{{ block.settings.vehicle_name }}</h3>
              <p>{{ block.settings.vehicle_description }}</p>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="vehicle-section">
    <!-- Vehicle Info Header -->
    <div class="selected-vehicle-header" id="selectedVehicleHeader" style="display: none;">
      <div class="vehicle-info">
        <span class="vehicle-name" id="selectedVehicleName"></span>
        <button class="change-vehicle-btn" id="changeVehicleBtn">Change Vehicle</button>
      </div>
    </div>

    <div class="vehicle-display view-front" id="vehicleDisplay">
      {% comment %} Zone hotspots - same as before {% endcomment %}
      {% for i in (1..11) %}
        <div class="zone-hotspot front-f{{ i }}" data-zone="f{{ i }}" data-view="front">F{{ i }}</div>
      {% endfor %}
      {% for i in (1..8) %}
        <div class="zone-hotspot rear-r{{ i }}" data-zone="r{{ i }}" data-view="rear" style="display: none;">R{{ i }}</div>
      {% endfor %}
      {% for i in (1..9) %}
        <div class="zone-hotspot side-s{{ i }}" data-zone="s{{ i }}" data-view="side" style="display: none;">S{{ i }}</div>
      {% endfor %}
      {% for i in (1..4) %}
        <div class="zone-hotspot trunk-t{{ i }}" data-zone="t{{ i }}" data-view="trunk" style="display: none;">T{{ i }}</div>
      {% endfor %}
      {% for i in (1..2) %}
        <div class="zone-hotspot interior-i{{ i }}" data-zone="i{{ i }}" data-view="interior" style="display: none;">I{{ i }}</div>
      {% endfor %}
    </div>

    <div class="view-slider-container">
      <div class="view-slider">
        <div class="view-option active" data-view="front">Front</div>
        <div class="view-option" data-view="rear">Rear</div>
        <div class="view-option" data-view="side">Side</div>
        <div class="view-option" data-view="trunk">Trunk</div>
        <div class="view-option" data-view="interior">Interior</div>
      </div>
    </div>
  </div>

  <div class="products-panel">
    <div class="panel-header">
      <div class="panel-title">{{ section.settings.panel_title | default: "Build Your Vehicle" }}</div>
      <div class="panel-subtitle">{{ section.settings.panel_subtitle | default: "Select a view and click on zones to add equipment" }}</div>
    </div>

    <div class="welcome-message" id="welcomeMessage">
      <h3>{{ section.settings.welcome_title | default: "Welcome to Vehicle Builder" }}</h3>
      <p>{{ section.settings.welcome_text | default: "Select your vehicle above, then click on any numbered zone to start building your setup." }}</p>
    </div>

    {% comment %} Zone content containers {% endcomment %}
    {% assign zone_mappings = 'f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,r1,r2,r3,r4,r5,r6,r7,r8,s1,s2,s3,s4,s5,s6,s7,s8,s9,t1,t2,t3,t4,i1,i2' | split: ',' %}
    
    {% for zone in zone_mappings %}
      <div class="zone-content" id="zone-{{ zone }}" style="display: none;">
        <div class="zone-title" id="zone-title-{{ zone }}"></div>
        <div class="zone-products" id="zone-products-{{ zone }}">
          <div class="loading-spinner">Loading products...</div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<div class="cart-summary" id="cartSummary" style="display: none;">
  <div class="cart-count">Cart: <span id="cartCount">{{ cart.item_count }}</span> items</div>
  <div>Total: {{ cart.total_price | money }}</div>
  <a href="{{ routes.cart_url }}" class="view-cart-btn">View Cart</a>
</div>

<script type="application/json" id="configurator-data">
{
  "collection_id": "{{ collection.id }}",
  "collection_handle": "{{ collection.handle }}",
  "cart_add_url": "{{ routes.cart_add_url }}",
  "shop_money_format": {{ shop.money_format | json }},
  "vehicles": [
    {% for block in section.blocks %}
      {% if block.type == 'vehicle' %}
        {
          "handle": "{{ block.settings.vehicle_handle }}",
          "name": "{{ block.settings.vehicle_name }}",
          "images": {
            "front": "{{ block.settings.front_image | img_url: 'master' }}",
            "rear": "{{ block.settings.rear_image | img_url: 'master' }}",
            "side": "{{ block.settings.side_image | img_url: 'master' }}",
            "trunk": "{{ block.settings.trunk_image | img_url: 'master' }}",
            "interior": "{{ block.settings.interior_image | img_url: 'master' }}"
          }
        }{% unless forloop.last %},{% endunless %}
      {% endif %}
    {% endfor %}
  ]
}
</script>

{{ 'vehicle-configurator-updated.js' | asset_url | script_tag }}

{% schema %}
{
  "name": "Vehicle Configurator",
  "tag": "section",
  "class": "vehicle-configurator-section",
  "settings": [
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "collection",
      "id": "product_collection",
      "label": "Product Collection",
      "info": "Select the collection containing configurator products"
    },
    {
      "type": "text",
      "id": "panel_title",
      "label": "Panel Title",
      "default": "Build Your Vehicle"
    },
    {
      "type": "text",
      "id": "panel_subtitle",
      "label": "Panel Subtitle",
      "default": "Select a view and click on zones to add equipment"
    }
  ],
  "blocks": [
    {
      "type": "vehicle",
      "name": "Vehicle",
      "settings": [
        {
          "type": "text",
          "id": "vehicle_handle",
          "label": "Vehicle Handle",
          "info": "URL-friendly identifier (e.g., ford-interceptor, chevy-tahoe)",
          "placeholder": "ford-interceptor"
        },
        {
          "type": "text",
          "id": "vehicle_name",
          "label": "Vehicle Name",
          "placeholder": "Ford Police Interceptor"
        },
        {
          "type": "textarea",
          "id": "vehicle_description",
          "label": "Vehicle Description",
          "placeholder": "Professional police vehicle configuration"
        },
        {
          "type": "image_picker",
          "id": "vehicle_image",
          "label": "Vehicle Selection Image"
        },
        {
          "type": "header",
          "content": "Vehicle View Images"
        },
        {
          "type": "image_picker",
          "id": "front_image",
          "label": "Front View Image"
        },
        {
          "type": "image_picker",
          "id": "rear_image",
          "label": "Rear View Image"
        },
        {
          "type": "image_picker",
          "id": "side_image",
          "label": "Side View Image"
        },
        {
          "type": "image_picker",
          "id": "trunk_image",
          "label": "Trunk View Image"
        },
        {
          "type": "image_picker",
          "id": "interior_image",
          "label": "Interior View Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Vehicle Configurator",
      "blocks": [
        {
          "type": "vehicle",
          "settings": {
            "vehicle_handle": "ford-interceptor",
            "vehicle_name": "Ford Police Interceptor"
          }
        },
        {
          "type": "vehicle",
          "settings": {
            "vehicle_handle": "chevy-tahoe",
            "vehicle_name": "Chevrolet Tahoe"
          }
        }
      ]
    }
  ]
}
{% endschema %}