{% comment %}
  Vehicle Zone Products Snippet
  File: snippets/vehicle-zone-products.liquid
  
  This snippet renders products for a specific vehicle and zone combination.
  It can be used for server-side rendering instead of AJAX loading.
  
  Parameters:
  - vehicle_handle: string (e.g., 'ford-interceptor')
  - zone_id: string (e.g., 'f1', 'r3')
  - collection: collection object
  - zone_title: string (optional)
{% endcomment %}

{% assign vehicle_handle = vehicle_handle | default: 'universal' %}
{% assign zone_id = zone_id | default: 'f1' %}
{% assign zone_title = zone_title | default: zone_id %}

{% comment %} Build tag filters for this vehicle/zone combination {% endcomment %}
{% assign vehicle_zone_tag = vehicle_handle | append: '-zone-' | append: zone_id %}
{% assign universal_zone_tag = 'universal-zone-' | append: zone_id %}

{% comment %} Filter products by tags {% endcomment %}
{% assign zone_products = collection.products | where: 'tags', vehicle_zone_tag %}
{% assign universal_products = collection.products | where: 'tags', universal_zone_tag %}

{% comment %} Combine vehicle-specific and universal products {% endcomment %}
{% assign all_zone_products = zone_products | concat: universal_products %}

{% comment %} Remove duplicates if any {% endcomment %}
{% assign unique_products = '' | split: '' %}
{% assign processed_ids = '' | split: '' %}

{% for product in all_zone_products %}
  {% unless processed_ids contains product.id %}
    {% assign unique_products = unique_products | append: product %}
    {% assign processed_ids = processed_ids | append: product.id %}
  {% endunless %}
{% endfor %}

<div class="zone-content-server" data-zone="{{ zone_id }}" data-vehicle="{{ vehicle_handle }}">
  <div class="zone-title">{{ zone_title }}</div>
  
  {% if unique_products.size > 0 %}
    <div class="zone-products">
      {% for product in unique_products %}
        {% assign variant = product.selected_or_first_available_variant %}
        {% assign is_universal = product.tags contains universal_zone_tag %}
        
        <div class="product-item" data-product-id="{{ product.id }}">
          {% comment %} Product Image {% endcomment %}
          {% if product.featured_media %}
            <div class="product-image-container">
              <img src="{{ product.featured_media | img_url: '300x200' }}" 
                   alt="{{ product.title | escape }}" 
                   class="product-image"
                   loading="lazy">
            </div>
          {% endif %}
          
          <div class="product-details">
            {% comment %} Product Name {% endcomment %}
            <div class="product-name">{{ product.title }}</div>
            
            {% comment %} Product Price {% endcomment %}
            <div class="product-price">
              {% if variant.compare_at_price > variant.price %}
                <span class="price-compare">{{ variant.compare_at_price | money }}</span>
                <span class="price-sale">{{ variant.price | money }}</span>
              {% else %}
                {{ variant.price | money }}
              {% endif %}
            </div>
            
            {% comment %} Product Description {% endcomment %}
            {% if product.description != blank %}
              <div class="product-description">
                {{ product.description | strip_html | truncate: 120 }}
              </div>
            {% endif %}
            
            {% comment %} Compatibility Badge {% endcomment %}
            {% if is_universal %}
              <div class="compatibility-badge universal">Universal Fit</div>
            {% else %}
              <div class="compatibility-badge vehicle-specific">
                Fits {{ vehicle_handle | replace: '-', ' ' | capitalize }}
              </div>
            {% endif %}
            
            {% comment %} Stock Status {% endcomment %}
            {% if variant.available %}
              <div class="stock-status in-stock">✓ In Stock</div>
            {% else %}
              <div class="stock-status out-of-stock">⚠ Out of Stock</div>
            {% endif %}
            
            {% comment %} Add to Cart Button {% endcomment %}
            {% if variant.available %}
              <button class="add-to-cart-btn" 
                      type="button"
                      data-variant-id="{{ variant.id }}" 
                      data-product-title="{{ product.title | escape }}"
                      data-product-price="{{ variant.price }}"
                      data-zone="{{ zone_id }}"
                      data-vehicle="{{ vehicle_handle }}">
                Add to Cart - {{ variant.price | money }}
              </button>
            {% else %}
              <button class="add-to-cart-btn sold-out" disabled>
                Sold Out
              </button>
            {% endif %}
            
            {% comment %} View Product Link {% endcomment %}
            <a href="{{ product.url }}" class="view-product-link">
              View Details
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
    
    {% comment %} Zone Summary {% endcomment %}
    <div class="zone-summary">
      <small>
        Showing {{ unique_products.size }} 
        {% if unique_products.size == 1 %}product{% else %}products{% endif %} 
        for {{ zone_title }}
        {% unless vehicle_handle == 'universal' %}
          compatible with {{ vehicle_handle | replace: '-', ' ' | capitalize }}
        {% endunless %}
      </small>
    </div>
    
  {% else %}
    {% comment %} No Products Found {% endcomment %}
    <div class="no-products">
      <p>No compatible products available for this zone.</p>
      {% unless vehicle_handle == 'universal' %}
        <small>Products may be vehicle-specific. Try selecting a different vehicle or check back later.</small>
      {% endunless %}
    </div>
  {% endif %}
</div>

{% comment %} Additional CSS for server-rendered products {% endcomment %}
<style>
  .zone-content-server .product-item {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    background: #fafafa;
  }
  
  .zone-content-server .product-item:hover {
    border-color: rgb(var(--color-foreground, 33, 34, 91));
    box-shadow: 0 2px 8px rgba(33, 34, 91, 0.1);
    transform: translateY(-2px);
  }
  
  .zone-content-server .product-image-container {
    margin-bottom: 12px;
    border-radius: 5px;
    overflow: hidden;
  }
  
  .zone-content-server .product-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  
  .zone-content-server .product-item:hover .product-image {
    transform: scale(1.05);
  }
  
  .zone-content-server .product-name {
    font-weight: 600;
    font-size: 16px;
    color: rgb(var(--color-foreground, 33, 34, 91));
    margin-bottom: 8px;
    line-height: 1.3;
  }
  
  .zone-content-server .product-price {
    font-size: 18px;
    font-weight: 700;
    color: rgb(var(--color-accent, 235, 212, 18));
    margin-bottom: 10px;
  }
  
  .zone-content-server .price-compare {
    text-decoration: line-through;
    color: #999;
    font-size: 14px;
    margin-right: 8px;
  }
  
  .zone-content-server .price-sale {
    color: #e74c3c;
  }
  
  .zone-content-server .product-description {
    font-size: 14px;
    color: rgba(var(--color-foreground, 33, 34, 91), 0.8);
    margin-bottom: 12px;
    line-height: 1.4;
  }
  
  .zone-content-server .compatibility-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .zone-content-server .compatibility-badge.universal {
    background: #e8f5e8;
    color: #2d5a2d;
    border: 1px solid #a8d5a8;
  }
  
  .zone-content-server .compatibility-badge.vehicle-specific {
    background: rgba(var(--color-accent, 235, 212, 18), 0.2);
    color: rgb(var(--color-foreground, 33, 34, 91));
    border: 1px solid rgba(var(--color-accent, 235, 212, 18), 0.4);
  }
  
  .zone-content-server .stock-status {
    font-size: 12px;
    margin-bottom: 10px;
    font-weight: 500;
  }
  
  .zone-content-server .stock-status.in-stock {
    color: #28a745;
  }
  
  .zone-content-server .stock-status.out-of-stock {
    color: #dc3545;
  }
  
  .zone-content-server .add-to-cart-btn {
    width: 100%;
    padding: 12px 16px;
    background: rgb(var(--color-accent, 235, 212, 18));
    color: rgb(var(--color-foreground, 33, 34, 91));
    border: none;
    border-radius: 5px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    margin-bottom: 8px;
  }
  
  .zone-content-server .add-to-cart-btn:hover:not(:disabled) {
    background: rgba(var(--color-accent, 235, 212, 18), 0.9);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(235, 212, 18, 0.3);
  }
  
  .zone-content-server .add-to-cart-btn:disabled,
  .zone-content-server .add-to-cart-btn.sold-out {
    background: #6c757d;
    color: white;
    cursor: not-allowed;
    transform: none;
  }
  
  .zone-content-server .view-product-link {
    display: inline-block;
    width: 100%;
    text-align: center;
    padding: 8px 16px;
    background: transparent;
    color: rgb(var(--color-foreground, 33, 34, 91));
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .zone-content-server .view-product-link:hover {
    border-color: rgb(var(--color-foreground, 33, 34, 91));
    background: #f8f9fa;
  }
  
  .zone-content-server .zone-summary {
    text-align: center;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
    color: rgba(var(--color-foreground, 33, 34, 91), 0.6);
  }
  
  .zone-content-server .no-products {
    text-align: center;
    padding: 40px 20px;
    color: rgba(var(--color-foreground, 33, 34, 91), 0.6);
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px dashed #e0e0e0;
  }
  
  .zone-content-server .no-products small {
    display: block;
    margin-top: 8px;
    font-size: 12px;
    opacity: 0.8;
  }
</style>